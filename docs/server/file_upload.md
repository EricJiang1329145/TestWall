# 文件上传处理

## 上传方式

系统支持两种文件上传方式：
1. 直接上传：小文件直接上传
2. 分片上传：大文件分片上传，适用于网络不稳定的环境

## 直接上传

### 处理流程
1. 前端选择文件并发起上传请求
2. 后端接收文件并验证文件类型
3. 生成唯一文件名并保存文件
4. 生成缩略图（图片/视频）
5. 返回文件名给前端

### 接口
**接口地址**: `/api/direct_upload`

**请求方法**: POST

**处理逻辑**:
1. 验证文件类型是否允许
2. 生成安全的文件名（UUID + 原始文件名）
3. 保存文件到`static/uploads/`目录
4. 根据文件类型进行处理：
   - 图片文件：转换为PNG格式并生成缩略图
   - 视频文件：转换为MP4格式并生成缩略图
5. 启动线程异步生成缩略图
6. 返回成功响应和文件名

## 分片上传

### 处理流程
1. 前端将大文件分割为多个分片
2. 依次上传每个分片到服务器
3. 所有分片上传完成后，发起合并请求
4. 服务器合并分片并生成最终文件
5. 生成缩略图并返回文件名

### 分片上传接口
**接口地址**: `/api/chunked_upload`

**请求方法**: POST

**处理逻辑**:
1. 接收分片文件和元数据（分片索引、总分片数、文件标识等）
2. 验证文件类型
3. 创建临时目录存储分片（以文件标识命名）
4. 保存分片到临时目录
5. 记录分片元数据

### 合并分片接口
**接口地址**: `/api/merge_chunks`

**请求方法**: POST

**处理逻辑**:
1. 根据文件标识找到对应的分片目录
2. 验证分片完整性
3. 按顺序合并所有分片
4. 生成唯一文件名并保存到`static/uploads/`目录
5. 根据文件类型进行处理（同直接上传）
6. 清理临时分片目录
7. 启动线程异步生成缩略图
8. 返回成功响应和文件名

## 文件类型验证

### 允许的文件类型
- 图片：jpg, jpeg, png, gif, webp
- 视频：mp4, avi, mov, wmv, flv
- 文档：pdf, doc, docx, txt

### 验证流程
1. 检查文件扩展名是否在允许列表中
2. 检查文件MIME类型
3. 验证文件内容是否与扩展名匹配

## 文件处理

### 图片处理
- 转换为PNG格式以确保兼容性
- 生成缩略图用于列表显示
- 保持原始宽高比

### 视频处理
- 转换为MP4格式以确保兼容性
- 生成视频第一帧作为缩略图
- 限制文件大小（10MB以内）

### 缩略图生成
- 图片缩略图：按比例缩放到最大边长200px
- 视频缩略图：提取第一帧并按比例缩放
- 缩略图保存在`static/tiny_files/`目录
- 缩略图文件名与原文件保持一致

## 文件存储安全

### 文件名安全
- 使用`secure_filename`函数处理原始文件名
- 生成UUID作为文件名前缀避免冲突
- 保留原始文件扩展名以确定文件类型

### 存储目录管理
- 所有上传文件存储在`static/uploads/`目录
- 缩略图存储在`static/tiny_files/`目录
- 分片临时文件存储在`static/chunks/`目录
- 删除的文件移动到`deleted_messages/`目录

## 异步处理

### 缩略图生成
缩略图生成是一个耗时操作，采用异步线程处理：
1. 文件上传完成后立即返回响应
2. 启动后台线程生成缩略图
3. 缩略图生成完成后自动更新文件状态

### 文件转换
图片和视频格式转换也采用异步处理，避免阻塞主线程。